// üîπ Chargement des variables d'environnement (en premier)
require('dotenv').config();

const listEndpoints = require('express-list-endpoints');


// üîπ Modules syst√®me
const fs = require('fs');
const path = require('path');

// üîπ Modules tiers
const express = require('express');
const mongoose = require('mongoose');
const cors = require('cors');
const cookieParser = require('cookie-parser');
const bodyParser = require('body-parser');
const {countDoc} = require('./actionDB');

const useragent = require('express-useragent');

// üéØ Initialisation Express
const app = express();

let myHost;
let ipAddressGlobal;

//??// üîπ Chargement des route
// 
// 
// Import de la fonction getInfo depuis le contr√¥leur
const { getInfo } = require("./controllers/ControlAgent");

// D√©finition de la route /info qui va utiliser la fonction getInfo
router.get("/info", getInfo);

// 
// 
// 
// s


// Configuration de MongoDB
const uriMEMBRES = process.env.URI_MEMBRES;

console.log('üöÄ ------------------------------------------------üöÄ');
console.log('üöÄ ~ server.js:192 ~ uriMEMBRES  ==> ', uriMEMBRES);
console.log('üöÄ ------------------------------------------------üöÄ');

const clusterName = uriMEMBRES.match(/@([^.]*)\./)[1].toUpperCase();

console.log('üöÄ --------------------------------------------------üöÄ');
console.log('üöÄ ~ server.js:198 ~ clusterName  ==> ', clusterName);
console.log('üöÄ --------------------------------------------------üöÄ');

mongoose.set('debug', true);

mongoose
	.connect(uriMEMBRES)
	.then(() =>
		console.log(
			`BDD connect√©e: ${mongoose.connection.name.toUpperCase()}`
		)
	)
	.catch((error) => console.error('Erreur de connexion √† la BDD:', error));

// üåç Configuration CORS avec gestion des origines dynamiques
const allowedOrigins = [
	'https://eliazoura.fr',
	'http://eliazoura.fr',
	'http://front.eliazoura.fr',
	'https://front.eliazoura.fr',
	'https://eli-front-swjt.onrender.com',
	'https://eli-front.onrender.com',
	'https://back.eliazoura.fr',
	'http://back.eliazoura.fr',
	/192\.168\.3\.19:\d+$/,
	/192\.234\.164\.249:\d+$/,
	/localhost:\d+$/,
];

const corsOptions = {
	origin: allowedOrigins,
	methods: ['GET', 'POST', 'PUT', 'DELETE'],
	credentials: true,
	optionsSuccessStatus: 200,
};


// üõ†Ô∏è Application des middlewares

// üîπ Enregistrer l'adresse IP de la requ√™te
// app.use((req, res, next) => {
// 	ipAddressGlobal =
// 		req.headers['x-forwarded-for'] || req.socket.remoteAddress;
// 	console.log('üìç IP enregistr√©e :', ipAddressGlobal);
// 	next();
// });

// üîπ Middleware CORS (plac√© avant le traitement des requ√™tes)
app.use(cors(corsOptions));

// üîπ Middleware pour le parsing des requ√™tes
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({extended: true}));

// üîπ Middleware Cookie-parser
app.use(cookieParser());

// üîπ D√©tection du User-Agent
app.use(useragent.express());

// üîπ Log de l'h√¥te de la requ√™te
// app.use((req, res, next) => {
// 	myHost = req.get('host');
// 	console.log('üöÄ ~ Host de la requ√™te :', myHost);
// 	next();
// });



// üîπ Configuration des vues
app.set('view engine', 'ejs');
app.set('views', [
	path.join(__dirname, 'views'),
	path.join(__dirname, 'views/partials'),
	path.join(__dirname, 'views/pages'),
	path.join(__dirname, 'more_views'),
]);

// üîπ Gestion des fichiers statiques
app.use(express.static('public'));
app.use('/js', express.static(path.join(__dirname, 'js')));

// üåê Connexion √† MongoDB
const dbURI =
	process.env.URI_MEMBRES || 'mongodb://localhost:27017/nomDeTonProjet';

mongoose
	.connect(dbURI, {
		useNewUrlParser: true,
		useUnifiedTopology: true,
	})
	.then(() => console.log('‚úÖ Connexion √† MongoDB r√©ussie'))
	.catch((error) =>
		console.error('‚ùå Erreur de connexion √† MongoDB :', error)
	);

// üîπ Route de test pour v√©rifier le serveur
app.get('/', (req, res) => {
	res.send('‚úÖ Serveur en ligne sur Render et connect√© √† MongoDB !');
});

// ‚ö†Ô∏è Gestion des erreurs (toujours en dernier)
app.use((err, req, res, next) => {
	console.error('‚ùå Erreur d√©tect√©e :', err.stack);
	res.status(500).send('Erreur serveur interne');
});



// Routes
const routes = require('./routes/routes');

app.get('/', (req, res) => {
	res.send('Hello Render!');
});
app.get('/test', (req, res) => {
	res.send('Hello TEST Render!');
});

app.use('/', routes);




console.log('Liste des endpoints :', listEndpoints(app));




// üåê D√©finition du PORT
const PORT = process.env.PORT || 3000;

// üöÄ D√©marrage du serveur (√©coute sur 0.0.0.0 pour Render)
app.listen(PORT, () => {
	console.log(`‚úÖ Serveur d√©marr√© sur le PORT ${PORT}, Host: ${myHost}`);
	const serverUrl = `http://localhost:${PORT}`;
	console.log(`‚úÖ Serveur d√©marr√© sur : ${serverUrl}`);

		// const db = mongoose.connection;
		// db.once('open', () => {
		// 	console.log(`Connexion √† ${clusterName} r√©ussie!`);
		// 	countDoc('lambdas')
		// 		.then((count) =>
		// 			console.log('Documents dans la collection:', count)
		// 		)
		// 		.catch((error) =>
		// 			console.error(
		// 				'Erreur lors du comptage des documents:',
		// 				error
		// 			)
		// 		);
		// });

		// db.on(
		// 	'error',
		// 	console.error.bind(
		// 		console,
		// 		'Erreur de connexion √† la base de donn√©es:'
		// 	)
		// );
});
